# Airtable Schema Sync Script

This script automatically syncs the Airtable schema to the HHMI Compliance module configuration file.

**Script**: `app/modules/extensions/hhmi-compliance/scripts/sync-airtable-schema.mts` (TypeScript, run with tsx)

## Purpose

The script fetches field metadata from Airtable's Metadata API and updates `app/modules/extensions/hhmi-compliance/backend/airtableConfig.ts` with all field names and IDs for the three configured tables:
- Publications
- Preprints  
- Scientists

## Prerequisites

- Node.js 18+ (for native fetch support)
- tsx installed globally or as dev dependency
- Airtable API key with read access to the base
- Base ID (defaults to `appuBoDw7bAfzfyK4`)

## Getting an Airtable API Key

1. Go to https://airtable.com/create/tokens
2. Create a new personal access token
3. Grant it `schema.bases:read` scope
4. Select the specific base you want to access
5. Copy the token

## Usage

### Option 1: Environment Variable (Recommended)

```bash
# Set the API key
export AIRTABLE_API_KEY="your_api_key_here"

# Run the script with tsx (from project root)
npx tsx app/modules/extensions/hhmi-compliance/scripts/sync-airtable-schema.mts

# Or with custom base ID
AIRTABLE_BASE_ID="appXXXXXXXXXXXXXX" npx tsx app/modules/extensions/hhmi-compliance/scripts/sync-airtable-schema.mts
```

### Option 2: Command Line Arguments

```bash
npx tsx app/modules/extensions/hhmi-compliance/scripts/sync-airtable-schema.mts <api-key> [base-id]
```

### Option 3: Using npm/package.json script

Add to `package.json`:

```json
{
  "scripts": {
    "sync:airtable": "tsx app/modules/extensions/hhmi-compliance/scripts/sync-airtable-schema.mts"
  }
}
```

Then run:

```bash
AIRTABLE_API_KEY=your_key npm run sync:airtable
```

## What It Does

1. **Fetches Metadata**: Calls Airtable's Metadata API to get all tables and fields
2. **Filters Tables**: Only processes the three configured tables (publications, preprints, scientists)
3. **Backs Up**: Creates a `.backup.ts` file of the existing config
4. **Generates Config**: Creates a new config with all fields sorted alphabetically
5. **Writes File**: Overwrites the config file with the updated schema

## Installing tsx

If you don't have tsx installed:

```bash
npm install -D tsx
# or globally
npm install -g tsx
```

## Output

The script generates a config file like:

```typescript
// Airtable Configuration
// Auto-generated by app/modules/extensions/hhmi-compliance/scripts/sync-airtable-schema.mts
export const AIRTABLE_CONFIG = {
  baseId: 'appuBoDw7bAfzfyK4',
  tables: {
    publications: {
      name: 'Publications',
      id: 'tblZw5sCSjmxfd4PC',
      fields: {
        doi: {
          name: 'DOI',
          id: 'fldXXXXXXXXXXXXXX',
        },
        // ... all other fields
      },
    },
    // ... other tables
  },
};
```

## Post-Script Steps

After running the script:

1. **Review Changes**: Check the git diff to see what changed
2. **Run Linter**: `npm run lint -- --fix` to format the file
3. **Run Type Check**: `npm run compile` to ensure no TypeScript errors
4. **Commit**: Commit the updated config file

## Troubleshooting

### "AIRTABLE_API_KEY is required"

Make sure you've set the API key as an environment variable or passed it as an argument.

### "Airtable API error: 401"

Your API key is invalid or doesn't have the required permissions. Create a new token with `schema.bases:read` scope.

### "Table not found in base"

The hardcoded table IDs in the script don't match your base. Update the `TARGET_TABLES` object in the script with your table IDs.

### "Cannot find module"

Make sure you're using `tsx` to run the TypeScript file from the project root:
```bash
npx tsx app/modules/extensions/hhmi-compliance/scripts/sync-airtable-schema.mts
```

## Updating Table IDs

If you need to sync different tables, edit the `TARGET_TABLES` object in the script:

```javascript
const TARGET_TABLES = {
  publications: 'tblZw5sCSjmxfd4PC',
  preprints: 'tblRWSiJvlOjt2OI4',
  scientists: 'tblKTlRedfiVcTo36',
  // Add more tables here
};
```

## Security Notes

- **Never commit your API key** to version control
- Store it in environment variables or a secrets manager
- Use personal access tokens instead of legacy API keys
- Grant minimal required scopes (`schema.bases:read` is sufficient)
- Rotate keys regularly

## Related Files

- `app/modules/extensions/hhmi-compliance/backend/airtableConfig.ts` - The config file that gets updated
- `app/modules/extensions/hhmi-compliance/backend/airtable.server.ts` - Uses the config for API calls
- `app/modules/extensions/hhmi-compliance/fields.md` - Documentation of field usage

